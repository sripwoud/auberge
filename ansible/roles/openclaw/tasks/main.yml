---
- name: Get Tailscale status as JSON
  ansible.builtin.command: tailscale status --json
  register: openclaw_tailscale_status_raw
  changed_when: false
  failed_when: false

- name: Parse Tailscale status JSON
  ansible.builtin.set_fact:
    openclaw_tailscale_status: "{{ openclaw_tailscale_status_raw.stdout | from_json }}"
  when: openclaw_tailscale_status_raw.rc == 0
  changed_when: false

- name: Extract Tailscale backend state
  ansible.builtin.set_fact:
    openclaw_tailscale_backend_state: "{{ openclaw_tailscale_status.BackendState | default('') }}"
  when: openclaw_tailscale_status is defined
  changed_when: false

- name: Set Tailscale IP fact
  ansible.builtin.set_fact:
    openclaw_tailscale_ip: "{{ openclaw_tailscale_status.Self.TailscaleIPs[0] }}"
  when:
    - openclaw_tailscale_status_raw.rc == 0
    - openclaw_tailscale_backend_state == "Running"
    - openclaw_tailscale_status.Self is defined
    - openclaw_tailscale_status.Self.TailscaleIPs is defined
    - openclaw_tailscale_status.Self.TailscaleIPs | length > 0
  changed_when: false

- name: Set gateway bind address
  ansible.builtin.set_fact:
    openclaw_gateway_bind: "{{ openclaw_tailscale_ip | default('127.0.0.1') }}"

- name: Display Tailscale IP
  ansible.builtin.debug:
    msg: "OpenClaw will bind to Tailscale IP: {{ openclaw_tailscale_ip }}"
  when: openclaw_tailscale_ip is defined

- name: Warn if Tailscale not found
  ansible.builtin.debug:
    msg: "WARNING: Tailscale not running or not authenticated. OpenClaw will bind to localhost only."
  when: openclaw_tailscale_ip is not defined

- name: Get user UID
  ansible.builtin.command: id -u {{ openclaw_user }}
  register: openclaw_user_uid
  changed_when: false

- name: Check if linger is already enabled for user
  ansible.builtin.stat:
    path: "/var/lib/systemd/linger/{{ openclaw_user }}"
  register: openclaw_linger_file

- name: Enable linger for user
  ansible.builtin.command: loginctl enable-linger {{ openclaw_user }}
  when: not openclaw_linger_file.stat.exists
  changed_when: true

- name: Check if Node.js is already installed
  ansible.builtin.command: node --version
  register: openclaw_node_check
  changed_when: false
  failed_when: false

- name: Download NodeSource setup script
  ansible.builtin.get_url:
    url: "https://deb.nodesource.com/setup_{{ openclaw_node_version }}.x"
    dest: /tmp/nodesource_setup.sh
    mode: "0755"
  when: openclaw_node_check.rc != 0

- name: Run NodeSource setup script
  ansible.builtin.command: bash /tmp/nodesource_setup.sh
  when: openclaw_node_check.rc != 0
  changed_when: true

- name: Install Node.js
  ansible.builtin.apt:
    name: nodejs
    state: present
    update_cache: true
  when: openclaw_node_check.rc != 0

- name: Clean up NodeSource setup script
  ansible.builtin.file:
    path: /tmp/nodesource_setup.sh
    state: absent

- name: Reset connection to pick up new PATH
  ansible.builtin.meta: reset_connection
  when: openclaw_node_check.rc != 0

- name: Verify Node.js version
  ansible.builtin.command: node --version
  register: openclaw_node_version_output
  changed_when: false

- name: Display Node.js version
  ansible.builtin.debug:
    msg: "Node.js version: {{ openclaw_node_version_output.stdout }}"

- name: Verify npm is installed
  ansible.builtin.command: npm --version
  register: openclaw_npm_version_output
  changed_when: false

- name: Display npm version
  ansible.builtin.debug:
    msg: "npm version: {{ openclaw_npm_version_output.stdout }}"

- name: Create systemd user directory
  ansible.builtin.file:
    path: "{{ openclaw_home }}/.config/systemd/user"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: "0755"

- name: Create OpenClaw directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: "0750"
  loop:
    - "{{ openclaw_config_dir }}"
    - "{{ openclaw_workspace_dir }}"

- name: Install OpenClaw globally
  community.general.npm:
    name: "openclaw@{{ openclaw_version }}"
    global: true
    state: present

- name: Verify openclaw binary in PATH
  ansible.builtin.command: which openclaw
  become: true
  become_user: "{{ openclaw_user }}"
  register: openclaw_which_result
  changed_when: false
  failed_when: openclaw_which_result.rc != 0

- name: Validate required OpenClaw environment variables
  ansible.builtin.assert:
    that:
      - openclaw_gateway_token is defined
      - openclaw_gateway_token | length > 0
      - openclaw_claude_ai_session_key is defined
      - openclaw_claude_ai_session_key | length > 0
    fail_msg: |
      OPENCLAW_GATEWAY_TOKEN and CLAUDE_AI_SESSION_KEY must be set and non-empty.
      Ensure mise environment is activated or run with: mise x ansible-playbook ...
    success_msg: "Required OpenClaw environment variables are set"

- name: Deploy environment file for OpenClaw
  ansible.builtin.template:
    src: env.j2
    dest: "{{ openclaw_config_dir }}/.env"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: "0600"
  notify: Restart openclaw gateway
  no_log: true

- name: Deploy OpenClaw gateway systemd service
  ansible.builtin.template:
    src: openclaw-gateway.service.j2
    dest: "{{ openclaw_home }}/.config/systemd/user/openclaw-gateway.service"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: "0644"
  notify: Reload systemd user

- name: Enable and start OpenClaw gateway service
  become: true
  become_user: "{{ openclaw_user }}"
  ansible.builtin.systemd:
    name: openclaw-gateway
    enabled: true
    state: started
    scope: user
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ openclaw_user_uid.stdout }}"

- name: Display deployment summary
  ansible.builtin.debug:
    msg:
      - "==================================="
      - "OpenClaw Deployment Complete!"
      - "==================================="
      - "Gateway Bind: {{ openclaw_gateway_bind }}"
      - "Gateway Port: {{ openclaw_gateway_port }}"
      - "Config Dir: {{ openclaw_config_dir }}"
      - "Workspace: {{ openclaw_workspace_dir }}"
      - ""
      - "Next steps:"
      - "1. Check service: systemctl --user status openclaw-gateway"
      - "2. View logs: journalctl --user -u openclaw-gateway -f"
      - "3. SSH to VPS: ssh {{ openclaw_user }}@{{ inventory_hostname }}"
      - "4. Run onboarding: openclaw onboard"
      - "5. Connect channels (WhatsApp/Telegram/etc)"
      - ""
      - "Web UI access:"
      - "{% if openclaw_tailscale_ip is defined %}http://{{ openclaw_tailscale_ip }}:{{ openclaw_gateway_port }}{% else %}SSH tunnel required{% endif %}"
      - ""
      - "Install Tailscale on laptop:"
      - "https://tailscale.com/download"
