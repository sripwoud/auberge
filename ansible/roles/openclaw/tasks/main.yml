---
- name: Add NodeSource APT repository key
  ansible.builtin.get_url:
    url: "https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key"
    dest: /usr/share/keyrings/nodesource.gpg
    mode: "0644"

- name: Add NodeSource APT repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [signed-by=/usr/share/keyrings/nodesource.gpg]
      https://deb.nodesource.com/node_{{ openclaw_node_version }}.x
      {{ ansible_distribution_release | lower }} main
    filename: "nodesource"
    state: present

- name: Install Node.js
  ansible.builtin.apt:
    name: nodejs
    state: present
    update_cache: true

- name: Verify Node.js version
  ansible.builtin.command: node --version
  register: openclaw_node_version_output
  changed_when: false

- name: Display Node.js version
  ansible.builtin.debug:
    msg: "Node.js version: {{ openclaw_node_version_output.stdout }}"

- name: Create systemd user directory
  ansible.builtin.file:
    path: "{{ openclaw_home }}/.config/systemd/user"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: "0755"

- name: Create OpenClaw directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: "0750"
  loop:
    - "{{ openclaw_config_dir }}"
    - "{{ openclaw_workspace_dir }}"

- name: Install OpenClaw globally
  community.general.npm:
    name: "openclaw@{{ openclaw_version }}"
    global: true
    state: present

- name: Verify openclaw binary in PATH
  ansible.builtin.command: which openclaw
  become_user: "{{ openclaw_user }}"
  register: openclaw_which_result
  changed_when: false
  failed_when: openclaw_which_result.rc != 0

- name: Validate required OpenClaw environment variables
  ansible.builtin.assert:
    that:
      - openclaw_gateway_token is defined
      - openclaw_gateway_token | length > 0
      - openclaw_claude_ai_session_key is defined
      - openclaw_claude_ai_session_key | length > 0
    fail_msg: |
      OPENCLAW_GATEWAY_TOKEN and CLAUDE_AI_SESSION_KEY must be set and non-empty.
      Ensure mise environment is activated or run with: mise x ansible-playbook ...
    success_msg: "Required OpenClaw environment variables are set"

- name: Deploy environment file for OpenClaw
  ansible.builtin.template:
    src: env.j2
    dest: "{{ openclaw_config_dir }}/.env"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: "0600"
  notify: Restart openclaw gateway
  no_log: true

- name: Deploy OpenClaw gateway systemd service
  ansible.builtin.template:
    src: openclaw-gateway.service.j2
    dest: "{{ openclaw_home }}/.config/systemd/user/openclaw-gateway.service"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: "0644"
  notify: Reload systemd user

- name: Get user UID
  ansible.builtin.command: id -u {{ openclaw_user }}
  register: openclaw_user_uid
  changed_when: false

- name: Enable linger for user
  ansible.builtin.command: loginctl enable-linger {{ openclaw_user }}
  changed_when: false

- name: Reload systemd user daemon
  become: true
  become_user: "{{ openclaw_user }}"
  ansible.builtin.systemd:
    daemon_reload: true
    scope: user
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ openclaw_user_uid.stdout }}"

- name: Enable and start OpenClaw gateway service
  become: true
  become_user: "{{ openclaw_user }}"
  ansible.builtin.systemd:
    name: openclaw-gateway
    enabled: true
    state: started
    scope: user
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ openclaw_user_uid.stdout }}"
