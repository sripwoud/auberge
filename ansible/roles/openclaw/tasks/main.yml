---
- name: Download Node.js setup script
  ansible.builtin.get_url:
    url: "https://deb.nodesource.com/setup_{{ openclaw_node_version }}.x"
    dest: /tmp/nodesource_setup.sh
    mode: "0755"

- name: Install Node.js repository
  ansible.builtin.command: bash /tmp/nodesource_setup.sh
  args:
    creates: /etc/apt/sources.list.d/nodesource.list
  changed_when: true

- name: Install Node.js
  ansible.builtin.apt:
    name: nodejs
    state: present
    update_cache: true

- name: Verify Node.js version
  ansible.builtin.command: node --version
  register: openclaw_node_version_output
  changed_when: false

- name: Display Node.js version
  ansible.builtin.debug:
    msg: "Node.js version: {{ openclaw_node_version_output.stdout }}"

- name: Install pnpm globally
  community.general.npm:
    name: pnpm
    global: true
    state: present

- name: Create systemd user directory
  ansible.builtin.file:
    path: "{{ openclaw_home }}/.config/systemd/user"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: "0755"

- name: Create OpenClaw directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: "0750"
  loop:
    - "{{ openclaw_config_dir }}"
    - "{{ openclaw_workspace_dir }}"

- name: Install OpenClaw globally
  become: true
  become_user: "{{ openclaw_user }}"
  community.general.npm:
    name: "openclaw@{{ openclaw_version }}"
    global: true
    state: present
  environment:
    HOME: "{{ openclaw_home }}"

- name: Deploy environment file for OpenClaw
  ansible.builtin.template:
    src: env.j2
    dest: "{{ openclaw_config_dir }}/.env"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: "0600"
  notify: Restart openclaw gateway

- name: Deploy OpenClaw gateway systemd service
  ansible.builtin.template:
    src: openclaw-gateway.service.j2
    dest: "{{ openclaw_home }}/.config/systemd/user/openclaw-gateway.service"
    owner: "{{ openclaw_user }}"
    group: "{{ openclaw_group }}"
    mode: "0644"
  notify: Reload systemd user

- name: Get user UID
  ansible.builtin.command: id -u {{ openclaw_user }}
  register: openclaw_user_uid
  changed_when: false

- name: Enable linger for user
  ansible.builtin.command: loginctl enable-linger {{ openclaw_user }}
  changed_when: false

- name: Reload systemd user daemon
  become: true
  become_user: "{{ openclaw_user }}"
  ansible.builtin.systemd:
    daemon_reload: true
    scope: user
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ openclaw_user_uid.stdout }}"

- name: Enable and start OpenClaw gateway service
  become: true
  become_user: "{{ openclaw_user }}"
  ansible.builtin.systemd:
    name: openclaw-gateway
    enabled: true
    state: started
    scope: user
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ openclaw_user_uid.stdout }}"
