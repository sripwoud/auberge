- name: Install and Configure Baikal
  block:
    - name: Install PHP and dependencies via apt
      ansible.builtin.apt:
        name:
          - php
          - php-fpm
          - php-sqlite3
          - php-xml
          - php-curl
          - php-mbstring
          - unzip
          - curl
        state: present
        update_cache: true

    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: apt

    - name: Detect installed PHP-FPM version
      ansible.builtin.set_fact:
        baikal_php_version: "{{ item.key | regex_replace('^php(\\d+\\.\\d+)-fpm$', '\\1') }}"
      loop: "{{ ansible_facts.packages | dict2items }}"
      when: item.key is match('^php\\d+\\.\\d+-fpm$')

    - name: Create baikal system user
      ansible.builtin.user:
        name: "{{ baikal_sys_user }}"
        system: true
        home: /
        shell: /usr/sbin/nologin
        createhome: false

    - name: Create Baikal installation directory
      ansible.builtin.file:
        path: "{{ baikal_install_dir }}"
        state: directory
        owner: "{{ baikal_sys_user }}"
        group: "{{ baikal_sys_user }}"
        mode: "0755"

    - name: Check if Baikal is already installed
      ansible.builtin.stat:
        path: "{{ baikal_install_dir }}/html/index.php"
      register: baikal_installed

    - name: Get latest Baikal release info from GitHub API
      when: not baikal_installed.stat.exists
      ansible.builtin.uri:
        url: https://api.github.com/repos/sabre-io/Baikal/releases/latest
        return_content: true
      register: baikal_release_info

    - name: Extract download URL from release info
      when: not baikal_installed.stat.exists
      ansible.builtin.set_fact:
        baikal_download_url: "{{ baikal_release_info.json.assets[0].browser_download_url }}"

    - name: Download Baikal release
      when: not baikal_installed.stat.exists
      ansible.builtin.get_url:
        url: "{{ baikal_download_url }}"
        dest: /tmp/baikal.zip
        mode: "0644"

    - name: Extract Baikal to temporary directory
      when: not baikal_installed.stat.exists
      ansible.builtin.unarchive:
        src: /tmp/baikal.zip
        dest: /tmp
        remote_src: true

    - name: Find extracted Baikal directory
      when: not baikal_installed.stat.exists
      ansible.builtin.find:
        paths: /tmp
        patterns: "baikal-*"
        file_type: directory
      register: baikal_extracted_dir

    - name: Move Baikal files to installation directory
      when: not baikal_installed.stat.exists
      ansible.builtin.shell: |
        mv {{ baikal_extracted_dir.files[0].path }}/* {{ baikal_install_dir }}/
        chown -R {{ baikal_sys_user }}:{{ baikal_sys_user }} {{ baikal_install_dir }}
      args:
        creates: "{{ baikal_install_dir }}/html/index.php"

    - name: Remove Baikal zip file
      when: not baikal_installed.stat.exists
      ansible.builtin.file:
        path: /tmp/baikal.zip
        state: absent

    - name: Remove extracted Baikal temp directory
      when: not baikal_installed.stat.exists and baikal_extracted_dir.files | length > 0
      ansible.builtin.file:
        path: "{{ baikal_extracted_dir.files[0].path }}"
        state: absent

    - name: Set proper permissions on Baikal directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ baikal_sys_user }}"
        group: "{{ baikal_sys_user }}"
        mode: "0755"
        recurse: true
      loop:
        - "{{ baikal_install_dir }}"
        - "{{ baikal_data_dir }}"

    - name: Ensure Specific directory is writable
      ansible.builtin.file:
        path: "{{ baikal_data_dir }}"
        state: directory
        owner: "{{ baikal_sys_user }}"
        group: "{{ baikal_sys_user }}"
        mode: "0750"

    - name: Deploy PHP-FPM pool configuration
      ansible.builtin.template:
        src: templates/baikal-fpm.conf.j2
        dest: /etc/php/{{ baikal_php_version }}/fpm/pool.d/baikal.conf
        owner: root
        group: root
        mode: "0644"
      notify: Restart php-fpm

    - name: Remove default PHP-FPM pool if it exists
      ansible.builtin.file:
        path: /etc/php/{{ baikal_php_version }}/fpm/pool.d/www.conf
        state: absent
      notify: Restart php-fpm

    - name: Copy Baikal Caddyfile to sites directory
      ansible.builtin.template:
        src: templates/Caddyfile.j2
        dest: "/etc/caddy/sites/{{ baikal_domain }}.caddyfile"
        owner: root
        group: root
        mode: "0644"
      notify: Restart caddy

    - name: Enable and start PHP-FPM service
      ansible.builtin.systemd_service:
        name: php{{ baikal_php_version }}-fpm
        enabled: true
        state: started
        daemon_reload: true
