---
- name: Deploy OpenClaw Personal AI Assistant
  hosts: vps
  become: true

  pre_tasks:
    - name: Verify Tailscale is installed and authenticated
      ansible.builtin.shell: |
        set -o pipefail
        tailscale status --json | jq -r '.BackendState'
      register: tailscale_backend_state
      changed_when: false
      failed_when: false

    - name: Get Tailscale IP
      ansible.builtin.shell: |
        set -o pipefail
        tailscale status --json | jq -r '.Self.TailscaleIPs[0]'
      register: tailscale_ip_result
      when: tailscale_backend_state.rc == 0 and tailscale_backend_state.stdout == "Running"
      changed_when: false

    - name: Set Tailscale IP fact
      ansible.builtin.set_fact:
        tailscale_ip: "{{ tailscale_ip_result.stdout }}"
      when:
        - tailscale_backend_state.rc == 0
        - tailscale_backend_state.stdout == "Running"
        - tailscale_ip_result.stdout is defined
        - tailscale_ip_result.stdout != "null"

    - name: Display Tailscale IP
      ansible.builtin.debug:
        msg: "OpenClaw will bind to Tailscale IP: {{ tailscale_ip }}"
      when: tailscale_ip is defined

    - name: Warn if Tailscale not found
      ansible.builtin.debug:
        msg: "WARNING: Tailscale not running or not authenticated. OpenClaw will bind to localhost only."
      when: tailscale_ip is not defined

  roles:
    - role: openclaw
      tags: [openclaw]

  post_tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "==================================="
          - "OpenClaw Deployment Complete!"
          - "==================================="
          - "Gateway Bind: {{ openclaw_gateway_bind }}"
          - "Gateway Port: {{ openclaw_gateway_port }}"
          - "Bridge Port: {{ openclaw_bridge_port }}"
          - "Config Dir: {{ openclaw_config_dir }}"
          - "Workspace: {{ openclaw_workspace_dir }}"
          - ""
          - "Next steps:"
          - "1. Check service: systemctl --user status openclaw-gateway"
          - "2. View logs: journalctl --user -u openclaw-gateway -f"
          - "3. SSH to VPS: ssh {{ openclaw_user }}@{{ inventory_hostname }}"
          - "4. Run onboarding: openclaw onboard"
          - "5. Connect channels (WhatsApp/Telegram/etc)"
          - ""
          - "Web UI access:"
          - "{% if tailscale_ip is defined %}http://{{ tailscale_ip }}:{{ openclaw_gateway_port }}{% else %}SSH tunnel required{% endif %}"
          - ""
          - "Install Tailscale on laptop:"
          - "https://tailscale.com/download"
