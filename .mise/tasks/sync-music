#!/usr/bin/env bash
#MISE description="Sync local music library to Navidrome on selfhost servers"
set -euo pipefail

# Configuration
MUSIC_SOURCE="${MUSIC_SOURCE:-$HOME/Music/}"
REMOTE_USER="${REMOTE_USER:-sripwoud}"  # Using personal admin user for file transfer

# Select target host
echo "Select target host for music sync:"
echo "1) selfhost-old (194.164.53.11)"
echo "2) selfhost (82.223.116.111)"
read -r -p "Enter choice [1-2]: " choice

case $choice in
  1)
    REMOTE_HOST="194.164.53.11"
    SSH_PORT="2209"
    HOST_NAME="selfhost-old"
    ;;
  2)
    REMOTE_HOST="82.223.116.111"
    SSH_PORT="22"  # Update after bootstrap
    HOST_NAME="selfhost"
    ;;
  *)
    echo "Invalid choice"
    exit 1
    ;;
esac

# Paths
REMOTE_PATH="/srv/music/"
SSH_KEY="${HOME}/.ssh/identities/sripwoud_${HOST_NAME}"

# Check if SSH key exists
if [[ ! -f "$SSH_KEY" ]]; then
  echo "‚ùå SSH key not found: $SSH_KEY"
  echo "Run 'mise run generate-ssh-keys' first"
  exit 1
fi

echo "üéµ Syncing music to Navidrome on ${HOST_NAME}..."
echo "Source: $MUSIC_SOURCE"
echo "Destination: $REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH"
echo ""

# Sync with progress and delete removed files
rsync -avzP \
  --delete \
  --exclude=".DS_Store" \
  --exclude="*.tmp" \
  -e "ssh -p $SSH_PORT -i $SSH_KEY" \
  "$MUSIC_SOURCE" \
  "$REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH"

echo ""
echo "‚úÖ Music sync complete! Navidrome will scan the library automatically."