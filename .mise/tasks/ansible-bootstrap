#!/usr/bin/env bash
#MISE description="Bootstrap new VPS with dual-user setup (first run only)"
set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

verify_host_key() {
  local host_ip="$1"
  local host_name="$2"

  echo -e "${YELLOW}‚ö†Ô∏è  Fetching SSH host key for $host_name ($host_ip)...${NC}"

  # Fetch the host key
  ssh-keyscan -H -p 22 "$host_ip" 2>/dev/null > /tmp/hostkey_temp

  if [[ ! -s /tmp/hostkey_temp ]]; then
    echo -e "${RED}‚ùå Failed to fetch host key. Is the server accessible?${NC}"
    exit 1
  fi

  # Display the host key fingerprint for verification
  echo -e "${YELLOW}Host key fingerprints:${NC}"
  ssh-keygen -lf /tmp/hostkey_temp

  echo ""
  read -r -p "Do these fingerprints match what your VPS provider shows? (yes/no): " response

  if [[ "$response" != "yes" ]]; then
    echo -e "${RED}‚ùå Bootstrap cancelled for security. Verify the host key manually.${NC}"
    exit 1
  fi

  # Add to known_hosts
  cat /tmp/hostkey_temp >> ~/.ssh/known_hosts
  rm /tmp/hostkey_temp

  echo -e "${GREEN}‚úÖ Host key verified and added to known_hosts${NC}"
}

run_bootstrap_playbook() {
  local host="$1"
  local bootstrap_user="$2"
  local host_ip="$3"

  echo -e "${GREEN}üöÄ Bootstrapping $host as user $bootstrap_user...${NC}"

  # Now we can run with host key checking enabled
  ansible-playbook \
    -i inventory.yml \
    playbooks/bootstrap.yml \
    --limit "$host" \
    -e "ansible_port=22" \
    -e "ansible_user=$bootstrap_user" \
    -e "ansible_host=$host_ip" \
    --ask-pass \
    | tee /tmp/bootstrap.log
}

extract_configured_port() {
  # Look for the SSH port in the output
  local ssh_port
  ssh_port=$(grep "SSH port configured:" /tmp/bootstrap.log 2>/dev/null | awk '{print $NF}' || echo "")

  if [[ -z "$ssh_port" ]]; then
    # Try to extract from role defaults
    ssh_port=$(grep -E "^ssh_port:" roles/ssh/defaults/main.yml 2>/dev/null | awk '{print $2}' || echo "59865")
    echo -e "${YELLOW}‚ö†Ô∏è  Could not determine SSH port from output, using: $ssh_port${NC}" >&2
  fi

  echo "$ssh_port"
}

update_inventory_port() {
  local host="$1"
  local ssh_port="$2"

  echo -e "${GREEN}üìù Updating inventory for $host with port $ssh_port...${NC}"

  # Update based on new inventory structure
  if [[ "$host" == "vibecoder" ]]; then
    dasel put -f inventory.yml -t int -v "$ssh_port" "all.children.vibecoding.hosts.$host.ansible_port"
  else
    dasel put -f inventory.yml -t int -v "$ssh_port" "all.children.selfhosted.hosts.$host.ansible_port"
  fi
}

main() {
  # Select host
  host=$(mise run select-host)

  # Get host details from inventory
  if [[ "$host" == "vibecoder" ]]; then
    bootstrap_user=$(dasel -f inventory.yml -r yaml "all.children.vibecoding.hosts.$host.bootstrap_user")
    # Get the actual IP from vault or prompt
    echo "Enter the IP address for $host:"
    read -r host_ip
  else
    bootstrap_user=$(dasel -f inventory.yml -r yaml "all.children.selfhosted.hosts.$host.bootstrap_user")
    echo "Enter the IP address for $host:"
    read -r host_ip
  fi

  # Verify host key for security
  verify_host_key "$host_ip" "$host"

  # Run bootstrap
  run_bootstrap_playbook "$host" "$bootstrap_user" "$host_ip"

  # Extract and update port
  ssh_port=$(extract_configured_port)
  update_inventory_port "$host" "$ssh_port"

  echo ""
  echo -e "${GREEN}‚úÖ Bootstrap complete!${NC}"
  echo -e "Host $host now accessible on port ${GREEN}$ssh_port${NC}"
  echo ""
  echo "Next steps:"
  echo "1. Generate SSH keys: mise run generate-ssh-keys"
  echo "2. Test connection: ssh -p $ssh_port ansible@$host_ip"
}

main "$@"