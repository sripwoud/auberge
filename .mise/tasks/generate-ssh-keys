#!/usr/bin/env bash
#MISE description="Generate SSH keys for dual-user Ansible setup (ansible + sripwoud users)"
set -euo pipefail

SSH_DIR="${HOME}/.ssh/identities"
HOSTS=(
  "selfhost-old"
  "selfhost"
  "vibecoder"
)

echo "ðŸ”‘ Generating SSH keys for dual-user setup..."
echo "Directory: ${SSH_DIR}"

# Create identities directory if it doesn't exist
mkdir -p "${SSH_DIR}"

for host in "${HOSTS[@]}"; do
  echo ""
  echo "ðŸ“¦ Processing ${host}..."

  # Generate ansible automation user key
  ansible_key="${SSH_DIR}/ansible_${host}"
  if [[ ! -f "${ansible_key}" ]]; then
    echo "  â†’ Generating ansible user key for ${host}..."
    ssh-keygen -t ed25519 -f "${ansible_key}" -C "ansible@${host}" -N ""
  else
    echo "  âœ“ Ansible key already exists: ${ansible_key}"
  fi

  # Generate personal admin key
  admin_key="${SSH_DIR}/sripwoud_${host}"
  if [[ ! -f "${admin_key}" ]]; then
    echo "  â†’ Generating admin key for ${host}..."
    ssh-keygen -t ed25519 -f "${admin_key}" -C "sripwoud@${host}" -N ""
  else
    echo "  âœ“ Admin key already exists: ${admin_key}"
  fi
done

echo ""
echo "âœ… SSH key generation complete!"
echo ""
echo "Keys generated:"
ls -la "${SSH_DIR}"/*.pub 2>/dev/null | awk '{print "  â€¢ " $NF}'
echo ""
echo "Next steps:"
echo "1. Run: mise run ansible-bootstrap"
echo "2. Create vault file: cp group_vars/all/hosts.vault.example group_vars/all/hosts.vault"
echo "3. Encrypt vault: ansible-vault encrypt group_vars/all/hosts.vault"
echo "4. Test connections: mise run ansible-test-connection"